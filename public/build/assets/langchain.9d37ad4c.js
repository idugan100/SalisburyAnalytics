var z={exports:{}},nt={exports:{}},it={};function S(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var Dt=S;S.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};S.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};S.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};S.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};S.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};S.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};S.prototype.start=S.prototype.try;S.prototype.errors=function(){return this._errors};S.prototype.attempts=function(){return this._attempts};S.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var i=this._errors[r],a=i.message,s=(n[a]||0)+1;n[a]=s,s>=t&&(e=i,t=s)}return e};(function(n){var e=Dt;n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in t)r[i]=t[i];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],s=0;s<r.retries;s++)a.push(this.createTimeout(s,r));return t&&t.forever&&!a.length&&a.push(this.createTimeout(s,r)),a.sort(function(o,u){return o-u}),a},n.createTimeout=function(t,r){var i=r.randomize?Math.random()+1:1,a=Math.round(i*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return a=Math.min(a,r.maxTimeout),a},n.wrap=function(t,r,i){if(r instanceof Array&&(i=r,r=null),!i){i=[];for(var a in t)typeof t[a]=="function"&&i.push(a)}for(var s=0;s<i.length;s++){var o=i[s],u=t[o];t[o]=function(c){var d=n.operation(r),h=Array.prototype.slice.call(arguments,1),f=h.pop();h.push(function(p){d.retry(p)||(p&&(arguments[0]=d.mainError()),f.apply(this,arguments))}),d.attempt(function(){c.apply(t,h)})}.bind(t,u),t[o].options=r}}})(it);(function(n){n.exports=it})(nt);const Ut=nt.exports,Ht=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class at extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const Bt=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},Mt=n=>Ht.includes(n),st=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const i=Ut.operation(e);i.attempt(async a=>{try{t(await n(a))}catch(s){if(!(s instanceof Error)){r(new TypeError(`Non-error was thrown: "${s}". You should only throw errors.`));return}if(s instanceof at)i.stop(),r(s.originalError);else if(s instanceof TypeError&&!Mt(s.message))i.stop(),r(s);else{Bt(s,a,e);try{await e.onFailedAttempt(s)}catch(o){r(o);return}i.retry(s)||r(i.mainError())}}})});z.exports=st;z.exports.default=st;z.exports.AbortError=at;let pe;const Ft=new Uint8Array(16);function Gt(){if(!pe&&(pe=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!pe))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return pe(Ft)}const Jt=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Vt(n){return typeof n=="string"&&Jt.test(n)}const _=[];for(let n=0;n<256;++n)_.push((n+256).toString(16).slice(1));function qt(n,e=0){return _[n[e+0]]+_[n[e+1]]+_[n[e+2]]+_[n[e+3]]+"-"+_[n[e+4]]+_[n[e+5]]+"-"+_[n[e+6]]+_[n[e+7]]+"-"+_[n[e+8]]+_[n[e+9]]+"-"+_[n[e+10]]+_[n[e+11]]+_[n[e+12]]+_[n[e+13]]+_[n[e+14]]+_[n[e+15]]}const zt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Fe={randomUUID:zt};function $(n,e,t){if(Fe.randomUUID&&!e&&!n)return Fe.randomUUID();n=n||{};const r=n.random||(n.rng||Gt)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(let i=0;i<16;++i)e[t+i]=r[i];return e}return qt(r)}var Wt=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()},ot={exports:{}};const Kt=/[\p{Lu}]/u,Qt=/[\p{Ll}]/u,Ge=/^[\p{Lu}](?![\p{Lu}])/gu,ut=/([\p{Alpha}\p{N}_]|$)/u,lt=/[_.\- ]+/,Yt=new RegExp("^"+lt.source),Je=new RegExp(lt.source+ut.source,"gu"),Ve=new RegExp("\\d+"+ut.source,"gu"),Zt=(n,e,t)=>{let r=!1,i=!1,a=!1;for(let s=0;s<n.length;s++){const o=n[s];r&&Kt.test(o)?(n=n.slice(0,s)+"-"+n.slice(s),r=!1,a=i,i=!0,s++):i&&a&&Qt.test(o)?(n=n.slice(0,s-1)+"-"+n.slice(s-1),a=i,i=!1,r=!0):(r=e(o)===o&&t(o)!==o,a=i,i=t(o)===o&&e(o)!==o)}return n},Xt=(n,e)=>(Ge.lastIndex=0,n.replace(Ge,t=>e(t))),er=(n,e)=>(Je.lastIndex=0,Ve.lastIndex=0,n.replace(Je,(t,r)=>e(r)).replace(Ve,t=>e(t))),ct=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(a=>a.trim()).filter(a=>a.length).join("-"):n=n.trim(),n.length===0)return"";const t=e.locale===!1?a=>a.toLowerCase():a=>a.toLocaleLowerCase(e.locale),r=e.locale===!1?a=>a.toUpperCase():a=>a.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=Zt(n,t,r)),n=n.replace(Yt,""),e.preserveConsecutiveUppercase?n=Xt(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),er(n,r))};ot.exports=ct;ot.exports.default=ct;function tr(n,e){return(e==null?void 0:e[n])||Wt(n)}function rr(n,e,t){const r={};for(const i in n)Object.hasOwn(n,i)&&(r[e(i,t)]=n[i]);return r}function qe(n){return Array.isArray(n)?[...n]:{...n}}function nr(n,e){const t=qe(n);for(const[r,i]of Object.entries(e)){const[a,...s]=r.split(".").reverse();let o=t;for(const u of s.reverse()){if(o[u]===void 0)break;o[u]=qe(o[u]),o=o[u]}o[a]!==void 0&&(o[a]={lc:1,type:"secret",id:[i]})}return t}function dt(n){const e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}class W{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,dt(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof W||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((i,a)=>(i[a]=a in this?this[a]:this.lc_kwargs[a],i),{});for(let i=Object.getPrototypeOf(this);i;i=Object.getPrototypeOf(i))Object.assign(e,Reflect.get(i,"lc_aliases",this)),Object.assign(t,Reflect.get(i,"lc_secrets",this)),Object.assign(r,Reflect.get(i,"lc_attributes",this));return Object.keys(t).forEach(i=>{let a=this,s=r;const[o,...u]=i.split(".").reverse();for(const l of u.reverse()){if(!(l in a)||a[l]===void 0)return;(!(l in s)||s[l]===void 0)&&(typeof a[l]=="object"&&a[l]!=null?s[l]={}:Array.isArray(a[l])&&(s[l]=[])),a=a[l],s=s[l]}o in a&&a[o]!==void 0&&(s[o]=s[o]||a[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:rr(Object.keys(t).length?nr(r,t):r,tr,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}class ir{}class he extends ir{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,dt(this.constructor)]}constructor(e){var t,r,i,a,s;super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:typeof process<"u"?((t=process.env)==null?void 0:t.LANGCHAIN_CALLBACKS_BACKGROUND)!=="true":!0}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=(r=e.ignoreLLM)!=null?r:this.ignoreLLM,this.ignoreChain=(i=e.ignoreChain)!=null?i:this.ignoreChain,this.ignoreAgent=(a=e.ignoreAgent)!=null?a:this.ignoreAgent,this.ignoreRetriever=(s=e.ignoreRetriever)!=null?s:this.ignoreRetriever)}copy(){return new this.constructor(this)}toJSON(){return W.prototype.toJSON.call(this)}toJSONNotImplemented(){return W.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends he{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:$()}),Object.assign(this,e)}}return new t}}var ht={exports:{}};(function(n){const t=(a=0)=>s=>`\x1B[${38+a};5;${s}m`,r=(a=0)=>(s,o,u)=>`\x1B[${38+a};2;${s};${o};${u}m`;function i(){const a=new Map,s={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};s.color.gray=s.color.blackBright,s.bgColor.bgGray=s.bgColor.bgBlackBright,s.color.grey=s.color.blackBright,s.bgColor.bgGrey=s.bgColor.bgBlackBright;for(const[o,u]of Object.entries(s)){for(const[l,c]of Object.entries(u))s[l]={open:`\x1B[${c[0]}m`,close:`\x1B[${c[1]}m`},u[l]=s[l],a.set(c[0],c[1]);Object.defineProperty(s,o,{value:u,enumerable:!1})}return Object.defineProperty(s,"codes",{value:a,enumerable:!1}),s.color.close="\x1B[39m",s.bgColor.close="\x1B[49m",s.color.ansi256=t(),s.color.ansi16m=r(),s.bgColor.ansi256=t(10),s.bgColor.ansi16m=r(10),Object.defineProperties(s,{rgbToAnsi256:{value:(o,u,l)=>o===u&&u===l?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(u/255*5)+Math.round(l/255*5),enumerable:!1},hexToRgb:{value:o=>{const u=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!u)return[0,0,0];let{colorString:l}=u.groups;l.length===3&&(l=l.split("").map(d=>d+d).join(""));const c=Number.parseInt(l,16);return[c>>16&255,c>>8&255,c&255]},enumerable:!1},hexToAnsi256:{value:o=>s.rgbToAnsi256(...s.hexToRgb(o)),enumerable:!1}}),s}Object.defineProperty(n,"exports",{enumerable:!0,get:i})})(ht);const ft=ht.exports;function Se(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function ar(n){return n.replace(/[-:.]/g,"")}function sr(n,e){return ar(`${new Date(n).toISOString().slice(0,-1)}000Z`)+e}class ve extends he{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){var i;const t=sr(e.start_time,e.id),r={...e};if(r.parent_run_id!==void 0){const a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await((i=this.onRunCreate)==null?void 0:i.call(this,r))}async _endTrace(e){var r;const t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){const t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,i,a,s,o,u){var f;const l=this._getExecutionOrder(i),c=Date.now(),d=o?{...a,metadata:o}:a,h={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:i,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:d!=null?d:{},tags:s||[]};return await this._startTrace(h),await((f=this.onLLMStart)==null?void 0:f.call(this,h)),h}async handleChatModelStart(e,t,r,i,a,s,o,u){var f;const l=this._getExecutionOrder(i),c=Date.now(),d=o?{...a,metadata:o}:a,h={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:i,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:d!=null?d:{},tags:s||[]};return await this._startTrace(h),await((f=this.onLLMStart)==null?void 0:f.call(this,h)),h}async handleLLMEnd(e,t){var i;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((i=this.onLLMEnd)==null?void 0:i.call(this,r)),await this._endTrace(r),r}async handleLLMError(e,t){var i;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((i=this.onLLMError)==null?void 0:i.call(this,r)),await this._endTrace(r),r}async handleChainStart(e,t,r,i,a,s,o,u){var h;const l=this._getExecutionOrder(i),c=Date.now(),d={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:i,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:o!=null?o:"chain",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return await this._startTrace(d),await((h=this.onChainStart)==null?void 0:h.call(this,d)),d}async handleChainEnd(e,t,r,i,a){var o;const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=Se(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(s.inputs=Se(a.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,s)),await this._endTrace(s),s}async handleChainError(e,t,r,i,a){var o;const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=e.message+(e!=null&&e.stack?`

${e.stack}`:""),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(s.inputs=Se(a.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,s)),await this._endTrace(s),s}async handleToolStart(e,t,r,i,a,s,o){var d;const u=this._getExecutionOrder(i),l=Date.now(),c={id:r,name:o!=null?o:e.id[e.id.length-1],parent_run_id:i,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return await this._startTrace(c),await((d=this.onToolStart)==null?void 0:d.call(this,c)),c}async handleToolEnd(e,t){var i;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((i=this.onToolEnd)==null?void 0:i.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var i;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((i=this.onToolError)==null?void 0:i.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var a;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const i=r;i.actions=i.actions||[],i.actions.push(e),i.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentAction)==null?void 0:a.call(this,r))}async handleAgentEnd(e,t){var i;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((i=this.onAgentEnd)==null?void 0:i.call(this,r)))}async handleRetrieverStart(e,t,r,i,a,s,o){var d;const u=this._getExecutionOrder(i),l=Date.now(),c={id:r,name:o!=null?o:e.id[e.id.length-1],parent_run_id:i,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return await this._startTrace(c),await((d=this.onRetrieverStart)==null?void 0:d.call(this,c)),c}async handleRetrieverEnd(e,t){var i;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((i=this.onRetrieverEnd)==null?void 0:i.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var i;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((i=this.onRetrieverError)==null?void 0:i.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var i;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((i=this.onText)==null?void 0:i.call(this,r)))}async handleLLMNewToken(e,t,r,i,a,s){var u;const o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:s==null?void 0:s.chunk}}),await((u=this.onLLMNewToken)==null?void 0:u.call(this,o,e)),o}}function C(n,e){return`${n.open}${e}${n.close}`}function I(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function D(n){if(!n.end_time)return"";const e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:T}=ft;class ze extends ve{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const i=this.runMap.get(r.parent_run_id);if(i)t.push(i),r=i;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((i,a,s)=>{const o=`${i.execution_order}:${i.run_type}:${i.name}`;return a===s.length-1?C(ft.bold,o):o}).join(" > ");return C(T.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${C(T.green,"[chain/start]")} [${t}] Entering Chain run with input: ${I(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${C(T.cyan,"[chain/end]")} [${t}] [${D(e)}] Exiting Chain run with output: ${I(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${C(T.red,"[chain/error]")} [${t}] [${D(e)}] Chain run errored with error: ${I(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(i=>i.trim())}:e.inputs;console.log(`${C(T.green,"[llm/start]")} [${t}] Entering LLM run with input: ${I(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${C(T.cyan,"[llm/end]")} [${t}] [${D(e)}] Exiting LLM run with output: ${I(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${C(T.red,"[llm/error]")} [${t}] [${D(e)}] LLM run errored with error: ${I(e.error,"[error]")}`)}onToolStart(e){var r;const t=this.getBreadcrumbs(e);console.log(`${C(T.green,"[tool/start]")} [${t}] Entering Tool run with input: "${(r=e.inputs.input)==null?void 0:r.trim()}"`)}onToolEnd(e){var r,i;const t=this.getBreadcrumbs(e);console.log(`${C(T.cyan,"[tool/end]")} [${t}] [${D(e)}] Exiting Tool run with output: "${(i=(r=e.outputs)==null?void 0:r.output)==null?void 0:i.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${C(T.red,"[tool/error]")} [${t}] [${D(e)}] Tool run errored with error: ${I(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${C(T.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${I(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${C(T.cyan,"[retriever/end]")} [${t}] [${D(e)}] Exiting Retriever run with output: ${I(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${C(T.red,"[retriever/error]")} [${t}] [${D(e)}] Retriever run errored with error: ${I(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${C(T.blue,"[agent/action]")} [${r}] Agent selected action: ${I(t.actions[t.actions.length-1],"[action]")}`)}}var pt={},mt={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function i(u,l,c){this.fn=u,this.context=l,this.once=c||!1}function a(u,l,c,d,h){if(typeof c!="function")throw new TypeError("The listener must be a function");var f=new i(c,d||u,h),p=t?t+l:l;return u._events[p]?u._events[p].fn?u._events[p]=[u._events[p],f]:u._events[p].push(f):(u._events[p]=f,u._eventsCount++),u}function s(u,l){--u._eventsCount===0?u._events=new r:delete u._events[l]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var l=[],c,d;if(this._eventsCount===0)return l;for(d in c=this._events)e.call(c,d)&&l.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(c)):l},o.prototype.listeners=function(l){var c=t?t+l:l,d=this._events[c];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,p=new Array(f);h<f;h++)p[h]=d[h].fn;return p},o.prototype.listenerCount=function(l){var c=t?t+l:l,d=this._events[c];return d?d.fn?1:d.length:0},o.prototype.emit=function(l,c,d,h,f,p){var v=t?t+l:l;if(!this._events[v])return!1;var m=this._events[v],j=arguments.length,F,g;if(m.fn){switch(m.once&&this.removeListener(l,m.fn,void 0,!0),j){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,c),!0;case 3:return m.fn.call(m.context,c,d),!0;case 4:return m.fn.call(m.context,c,d,h),!0;case 5:return m.fn.call(m.context,c,d,h,f),!0;case 6:return m.fn.call(m.context,c,d,h,f,p),!0}for(g=1,F=new Array(j-1);g<j;g++)F[g-1]=arguments[g];m.fn.apply(m.context,F)}else{var jt=m.length,ie;for(g=0;g<jt;g++)switch(m[g].once&&this.removeListener(l,m[g].fn,void 0,!0),j){case 1:m[g].fn.call(m[g].context);break;case 2:m[g].fn.call(m[g].context,c);break;case 3:m[g].fn.call(m[g].context,c,d);break;case 4:m[g].fn.call(m[g].context,c,d,h);break;default:if(!F)for(ie=1,F=new Array(j-1);ie<j;ie++)F[ie-1]=arguments[ie];m[g].fn.apply(m[g].context,F)}}return!0},o.prototype.on=function(l,c,d){return a(this,l,c,d,!1)},o.prototype.once=function(l,c,d){return a(this,l,c,d,!0)},o.prototype.removeListener=function(l,c,d,h){var f=t?t+l:l;if(!this._events[f])return this;if(!c)return s(this,f),this;var p=this._events[f];if(p.fn)p.fn===c&&(!h||p.once)&&(!d||p.context===d)&&s(this,f);else{for(var v=0,m=[],j=p.length;v<j;v++)(p[v].fn!==c||h&&!p[v].once||d&&p[v].context!==d)&&m.push(p[v]);m.length?this._events[f]=m.length===1?m[0]:m:s(this,f)}return this},o.prototype.removeAllListeners=function(l){var c;return l?(c=t?t+l:l,this._events[c]&&s(this,c)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(mt);var Ee={exports:{}},or=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})));const ur=or;class wt extends Error{constructor(e){super(e),this.name="TimeoutError"}}const yt=(n,e,t)=>new Promise((r,i)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}const a=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(u){i(u)}return}const s=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new wt(s);typeof n.cancel=="function"&&n.cancel(),i(o)},e);ur(n.then(r,i),()=>{clearTimeout(a)})});Ee.exports=yt;Ee.exports.default=yt;Ee.exports.TimeoutError=wt;var je={},De={};Object.defineProperty(De,"__esModule",{value:!0});function lr(n,e,t){let r=0,i=n.length;for(;i>0;){const a=i/2|0;let s=r+a;t(n[s],e)<=0?(r=++s,i-=a+1):i=a}return r}De.default=lr;Object.defineProperty(je,"__esModule",{value:!0});const cr=De;class dr{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);const r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}const i=cr.default(this._queue,r,(a,s)=>s.priority-a.priority);this._queue.splice(i,0,r)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}}je.default=dr;Object.defineProperty(pt,"__esModule",{value:!0});const hr=mt.exports,gt=Ee.exports,fr=je,me=()=>{},pr=new gt.TimeoutError;class mr extends hr{constructor(e){var t,r,i,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=me,this._resolveIdle=me,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:fr.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(a=(i=e.interval)===null||i===void 0?void 0:i.toString())!==null&&a!==void 0?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=me,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=me,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,i)=>{const a=async()=>{this._pendingCount++,this._intervalCount++;try{const s=this._timeout===void 0&&t.timeout===void 0?e():gt.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&i(pr)});r(await s)}catch(s){i(s)}this._next()};this._queue.enqueue(a,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var N=pt.default=mr;const wr=[400,401,403,404,405,406,407,408],yr=[409];class gr{constructor(e){var r,i;Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=(r=e.maxConcurrency)!=null?r:1/0,this.maxRetries=(i=e.maxRetries)!=null?i:6;const t="default"in N?N.default:N;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>z.exports(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt(r){var a;if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||(r==null?void 0:r.code)==="ECONNABORTED")throw r;const i=(a=r==null?void 0:r.response)==null?void 0:a.status;if(i){if(wr.includes(+i))throw r;if(yr.includes(+i))return}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((i,a)=>{var s;(s=e.signal)==null||s.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}function We(n){return typeof(n==null?void 0:n._getType)=="function"}function Ke(n){const e={type:n._getType(),data:{content:n.content}};return(n==null?void 0:n.additional_kwargs)&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}let k;const _r=()=>typeof window<"u"&&typeof window.document<"u",br=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",vr=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),_t=()=>typeof Deno<"u",Er=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!_t(),Cr=()=>k||(_r()?k="browser":Er()?k="node":br()?k="webworker":vr()?k="jsdom":_t()?k="deno":k="other",k);let Ie;async function Tr(){if(Ie===void 0){const n=Cr(),e=Sr();Ie={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:bt,...e}}return Ie}function Ar(){const n=Or()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[r,i]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof i=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=i:e[r]=i);return e}function Or(){try{return typeof process<"u"&&process.env?Object.entries(process.env).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function Q(n){var e;try{return typeof process<"u"?(e=process.env)==null?void 0:e[n]:void 0}catch{return}}let Re;function Sr(){if(Re!==void 0)return Re;const n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of n){const r=Q(t);r!==void 0&&(e[t]=r)}return Re=e,e}const Qe=n=>{const t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},G=async(n,e)=>{const t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};async function Ir(n){const e=[];for await(const t of n)e.push(t);return e}function Pe(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function y(n){if(!Vt(n))throw new Error(`Invalid UUID: ${n}`)}class Ue{constructor(e={}){var r,i,a,s,o,u,l,c;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=Ue.getDefaultClientConfig();this.apiUrl=(i=Pe((r=e.apiUrl)!=null?r:t.apiUrl))!=null?i:"",this.apiKey=Pe((a=e.apiKey)!=null?a:t.apiKey),this.webUrl=Pe((s=e.webUrl)!=null?s:t.webUrl),this.validateApiKeyIfHosted(),this.timeout_ms=(o=e.timeout_ms)!=null?o:12e3,this.caller=new gr((u=e.callerOptions)!=null?u:{}),this.hideInputs=(l=e.hideInputs)!=null?l:t.hideInputs,this.hideOutputs=(c=e.hideOutputs)!=null?c:t.hideOutputs}static getDefaultClientConfig(){var a;const e=Q("LANGCHAIN_API_KEY"),t=(a=Q("LANGCHAIN_ENDPOINT"))!=null?a:"https://api.smith.langchain.com",r=Q("LANGCHAIN_HIDE_INPUTS")==="true",i=Q("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:i}}validateApiKeyIfHosted(){if(!Qe(this.apiUrl)&&!this.apiKey)throw new Error("API key must be provided when using hosted LangSmith API")}getHostUrl(){return this.webUrl?this.webUrl:Qe(this.apiUrl)?(this.webUrl="http://localhost","http://localhost"):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com","https://dev.smith.langchain.com"):(this.webUrl="https://smith.langchain.com","https://smith.langchain.com")}get headers(){const e={"User-Agent":`langsmith-js/${bt}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs?{}:e}processOutputs(e){return this.hideOutputs?{}:e}async _getResponse(e,t){var s;const r=(s=t==null?void 0:t.toString())!=null?s:"",i=`${this.apiUrl}${e}?${r}`,a=await this.caller.call(fetch,i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!a.ok)throw new Error(`Failed to fetch ${e}: ${a.status} ${a.statusText}`);return a}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0;const i=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(i));const a=`${this.apiUrl}${e}?${t}`,s=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);const o=await s.json();if(o.length===0||(yield o,o.length<i))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",i="runs"){const a=t?{...t}:{};for(;;){const o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),body:JSON.stringify(a)})).json();if(!o||!o[i])break;yield o[i];const u=o.cursors;if(!u||!u.next)break;a.cursor=u.next}}async createRun(e){var c,d,h;const t={...this.headers,"Content-Type":"application/json"},r=(c=e.extra)!=null?c:{},i=r.metadata,a=await Tr(),s=Ar(),o=e.project_name;delete e.project_name;const u={session_name:o,...e,extra:{...e.extra,runtime:{...a,...r.runtime},metadata:{...s,...s.revision_id||e.revision_id?{revision_id:(d=e.revision_id)!=null?d:s.revision_id}:{},...i}}};u.inputs=this.processInputs(u.inputs),u.outputs&&(u.outputs=this.processOutputs(u.outputs)),u.start_time=(h=e.start_time)!=null?h:Date.now();const l=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms)});await G(l,"create run")}async updateRun(e,t){y(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...this.headers,"Content-Type":"application/json"},i=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});await G(i,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){y(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let i;t.session_id?i=t.session_id:r!=null&&r.projectName?i=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?i=r==null?void 0:r.projectId:i=(await this.readProject({projectName:Q("LANGCHAIN_PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${i}/r/${t.id}?poll=true`}else if(e!==void 0){const i=await this.readRun(e);if(!i.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${i.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await Ir(this.listRuns({id:e.child_run_ids})),r={},i={};t.sort((a,s)=>{var o,u;return((o=a==null?void 0:a.dotted_order)!=null?o:"").localeCompare((u=s==null?void 0:s.dotted_order)!=null?u:"")});for(const a of t){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);a.parent_run_id in r||(r[a.parent_run_id]=[]),r[a.parent_run_id].push(a),i[a.id]=a}e.child_runs=r[e.id]||[];for(const a in r)a!==e.id&&(i[a].child_runs=r[a]);return e}async*listRuns({projectId:e,projectName:t,parentRunId:r,referenceExampleId:i,startTime:a,executionOrder:s,runType:o,error:u,id:l,query:c,filter:d,limit:h}){let f=e;if(t){if(e)throw new Error("Only one of projectId or projectName may be given");f=(await this.readProject({projectName:t})).id}const p={session:f?[f]:null,run_type:o,reference_example:i,query:c,filter:d,execution_order:s,parent_run:r?[r]:null,start_time:a?a.toISOString():null,error:u,id:l,limit:h};for await(const v of this._getCursorPaginatedList("/runs/query",p))yield*v}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||$()};y(e);const a=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){y(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await G(t,"unshare run")}async readRunSharedLink(e){y(e);const r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(t!==void 0)for(const s of t)r.append("id",s);return y(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),y(e);const i=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};y(e);const a=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){y(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await G(t,"unshare dataset")}async readSharedDataset(e){return y(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:i=!1,projectExtra:a=null,referenceDatasetId:s=null}){const o=i?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,l=a||{};r&&(l.metadata=r);const c={name:e,extra:l,description:t};s!==null&&(c.reference_dataset_id=s);const d=await this.caller.call(fetch,u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)}),h=await d.json();if(!d.ok)throw new Error(`Failed to create session ${e}: ${d.status} ${d.statusText}`);return h}async updateProject(e,{name:t=null,description:r=null,metadata:i=null,projectExtra:a=null,endTime:s=null}){const o=`${this.apiUrl}/sessions/${e}`;let u=a;i&&(u={...u||{},metadata:i});const l={name:t,extra:u,description:r,end_time:s?new Date(s).toISOString():null},c=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)}),d=await c.json();if(!c.ok)throw new Error(`Failed to update project ${e}: ${c.status} ${c.statusText}`);return d}async readProject({projectId:e,projectName:t}){let r="/sessions";const i=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)y(e),r+=`/${e}`;else if(t!==void 0)i.append("name",t);else throw new Error("Must provide projectName or projectId");const a=await this._get(r,i);let s;if(Array.isArray(a)){if(a.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);s=a[0]}else s=a;return s}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:i,referenceDatasetName:a,referenceFree:s}={}){const o=new URLSearchParams;if(e!==void 0)for(const u of e)o.append("id",u);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),i!==void 0)o.append("reference_dataset",i);else if(a!==void 0){const u=await this.readDataset({datasetName:a});o.append("reference_dataset",u.id)}s!==void 0&&o.append("reference_free",s.toString());for await(const u of this._getPaginated("/sessions",o))yield*u}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,y(r);const i=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await G(i,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:i,description:a,dataType:s,name:o}){const u=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach(h=>{l.append("input_keys",h)}),i.forEach(h=>{l.append("output_keys",h)}),a&&l.append("description",a),s&&l.append("data_type",s),o&&l.append("name",o);const c=await this.caller.call(fetch,u,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms)});if(!c.ok){const h=await c.json();throw h.detail&&h.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${c.status} ${c.statusText}`)}return await c.json()}async createDataset(e,{description:t,dataType:r}={}){const i={name:e,description:t};r&&(i.data_type=r);const a=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms)});if(!a.ok){const o=await a.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${a.status} ${a.statusText}`)}return await a.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const i=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)y(e),r+=`/${e}`;else if(t!==void 0)i.append("name",t);else throw new Error("Must provide datasetName or datasetId");const a=await this._get(r,i);let s;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);s=a[0]}else s=a;return s}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:i,datasetNameContains:a}={}){const s="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(const u of r)o.append("id",u);i!==void 0&&o.append("name",i),a!==void 0&&o.append("name_contains",a);for await(const u of this._getPaginated(s,o))yield*u}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",i=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(i=(await this.readDataset({datasetName:t})).id),i!==void 0)y(i),r+=`/${i}`;else throw new Error("Must provide datasetName or datasetId");const a=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!a.ok)throw new Error(`Failed to delete ${r}: ${a.status} ${a.statusText}`);await a.json()}async createExample(e,t,{datasetId:r,datasetName:i,createdAt:a,exampleId:s}){let o=r;if(o===void 0&&i===void 0)throw new Error("Must provide either datasetName or datasetId");if(o!==void 0&&i!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");o===void 0&&(o=(await this.readDataset({datasetName:i})).id);const u=a||new Date,l={dataset_id:o,inputs:e,outputs:t,created_at:u==null?void 0:u.toISOString(),id:s},c=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)});if(!c.ok)throw new Error(`Failed to create example: ${c.status} ${c.statusText}`);return await c.json()}async createExamples(e){const{inputs:t,outputs:r,sourceRunIds:i,exampleIds:a,datasetId:s,datasetName:o}=e;let u=s;if(u===void 0&&o===void 0)throw new Error("Must provide either datasetName or datasetId");if(u!==void 0&&o!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");u===void 0&&(u=(await this.readDataset({datasetName:o})).id);const l=t.map((h,f)=>({dataset_id:u,inputs:h,outputs:r?r[f]:void 0,id:a?a[f]:void 0,source_run_id:i?i[f]:void 0})),c=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)});if(!c.ok)throw new Error(`Failed to create examples: ${c.status} ${c.statusText}`);return await c.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const i=e.map(s=>We(s)?Ke(s):s),a=We(t)?Ke(t):t;return this.createExample({input:i},{output:a},r)}async readExample(e){y(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r}={}){let i;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)i=e;else if(t!==void 0)i=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const a=new URLSearchParams({dataset:i});if(r!==void 0)for(const s of r)a.append("id",s);for await(const s of this._getPaginated("/examples",a))yield*s}async deleteExample(e){y(e);const t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){y(e);const r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:i,referenceExample:a}={loadChildRuns:!1}){var c;let s;if(typeof e=="string")s=await this.readRun(e,{loadChildRuns:i});else if(typeof e=="object"&&"id"in e)s=e;else throw new Error(`Invalid run type: ${typeof e}`);s.reference_example_id!==null&&s.reference_example_id!==void 0&&(a=await this.readExample(s.reference_example_id));const o=await t.evaluateRun(s,a);let u=r!=null?r:{};o.evaluatorInfo&&(u={...u,...o.evaluatorInfo});const l=(c=o.targetRunId)!=null?c:s.id;return await this.createFeedback(l,o.key,{score:o==null?void 0:o.score,value:o==null?void 0:o.value,comment:o==null?void 0:o.comment,correction:o==null?void 0:o.correction,sourceInfo:u,feedbackSourceType:"model",sourceRunId:o==null?void 0:o.sourceRunId})}async createFeedback(e,t,{score:r,value:i,correction:a,comment:s,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:l,feedbackId:c,eager:d=!1}){var m;const h={type:u!=null?u:"api",metadata:o!=null?o:{}};l!==void 0&&(h==null?void 0:h.metadata)!==void 0&&!h.metadata.__run&&(h.metadata.__run={run_id:l}),(h==null?void 0:h.metadata)!==void 0&&((m=h.metadata.__run)==null?void 0:m.run_id)!==void 0&&y(h.metadata.__run.run_id);const f={id:c!=null?c:$(),run_id:e,key:t,score:r,value:i,correction:a,comment:s,feedback_source:h},p=`${this.apiUrl}/feedback`+(d?"/eager":""),v=await this.caller.call(fetch,p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(f),signal:AbortSignal.timeout(this.timeout_ms)});return await G(v,"create feedback"),f}async updateFeedback(e,{score:t,value:r,correction:i,comment:a}){const s={};t!=null&&(s.score=t),r!=null&&(s.value=r),i!=null&&(s.correction=i),a!=null&&(s.comment=a),y(e);const o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms)});await G(o,"update feedback")}async readFeedback(e){y(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){y(e);const t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const i=new URLSearchParams;if(e&&i.append("run",e.join(",")),t)for(const a of t)i.append("key",a);if(r)for(const a of r)i.append("source",a);for await(const a of this._getPaginated("/feedback",i))yield*a}}const bt="0.0.66",Rr=()=>typeof window<"u"&&typeof window.document<"u",Pr=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",xr=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),vt=()=>typeof Deno<"u",kr=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!vt(),$r=()=>{let n;return Rr()?n="browser":kr()?n="node":Pr()?n="webworker":xr()?n="jsdom":vt()?n="deno":n="other",n};let xe;async function Lr(){return xe===void 0&&(xe={library:"langchain-js",runtime:$r()}),xe}function ae(n){var e;try{return typeof process<"u"?(e=process.env)==null?void 0:e[n]:void 0}catch{return}}class Nr extends ve{constructor(e={}){var a;super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:i}=e;this.projectName=(a=r!=null?r:ae("LANGCHAIN_PROJECT"))!=null?a:ae("LANGCHAIN_SESSION"),this.exampleId=t,this.client=i!=null?i:new Ue({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Lr()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async _persistRunSingle(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async _updateRunSingle(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs};await this.client.updateRun(e.id,t)}async onRetrieverStart(e){await this._persistRunSingle(e)}async onRetrieverEnd(e){await this._updateRunSingle(e)}async onRetrieverError(e){await this._updateRunSingle(e)}async onLLMStart(e){await this._persistRunSingle(e)}async onLLMEnd(e){await this._updateRunSingle(e)}async onLLMError(e){await this._updateRunSingle(e)}async onChainStart(e){await this._persistRunSingle(e)}async onChainEnd(e){await this._updateRunSingle(e)}async onChainError(e){await this._updateRunSingle(e)}async onToolStart(e){await this._persistRunSingle(e)}async onToolEnd(e){await this._updateRunSingle(e)}async onToolError(e){await this._updateRunSingle(e)}}function te(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?[...n,...e]:[...n,{type:"text",text:e}]}class K extends W{get lc_aliases(){return{additional_kwargs:"additional_kwargs"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t}),e.additional_kwargs||(e.additional_kwargs={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}toChunk(){const e=this._getType();if(e==="human")return new se({...this});if(e==="ai")return new oe({...this});if(e==="system")return new ue({...this});if(e==="function")return new le({...this});if(Ce.isInstance(this))return new ce({...this});throw new Error("Unknown message type.")}}function Ye(n){return Array.isArray(n)&&n.every(e=>typeof e.index=="number")}class re extends K{static _mergeAdditionalKwargs(e,t){var i,a;const r={...e};for(const[s,o]of Object.entries(t))if(r[s]===void 0)r[s]=o;else{if(typeof r[s]!=typeof o)throw new Error(`additional_kwargs[${s}] already exists in the message chunk, but with a different type.`);if(typeof r[s]=="string")r[s]=r[s]+o;else if(!Array.isArray(r[s])&&typeof r[s]=="object")r[s]=this._mergeAdditionalKwargs(r[s],o);else if(s==="tool_calls"&&Ye(r[s])&&Ye(o))for(const u of o)((i=r[s])==null?void 0:i[u.index])!==void 0?r[s]=(a=r[s])==null?void 0:a.map((l,c)=>{var d,h,f;return c!==u.index?l:{...l,...u,function:{name:(d=u.function.name)!=null?d:l.function.name,arguments:((h=l.function.arguments)!=null?h:"")+((f=u.function.arguments)!=null?f:"")}}}):r[s][u.index]=u;else throw new Error(`additional_kwargs[${s}] already exists in this message chunk.`)}return r}}class Et extends K{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class se extends re{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new se({content:te(this.content,e.content),additional_kwargs:se._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class jr extends K{static lc_name(){return"AIMessage"}_getType(){return"ai"}}class oe extends re{static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){return new oe({content:te(this.content,e.content),additional_kwargs:oe._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class Dr extends K{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class ue extends re{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new ue({content:te(this.content,e.content),additional_kwargs:ue._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class Ur extends K{static lc_name(){return"FunctionMessage"}constructor(e,t){typeof e=="string"&&(e={content:e,name:t}),super(e)}_getType(){return"function"}}class le extends re{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){var t;return new le({content:te(this.content,e.content),additional_kwargs:le._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),name:(t=this.name)!=null?t:""})}}class Hr extends K{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){typeof e=="string"&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}_getType(){return"tool"}}class we extends re{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new we({content:te(this.content,e.content),additional_kwargs:we._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),tool_call_id:this.tool_call_id})}}class Ce extends K{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return Ce}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}}class ce extends re{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new ce({content:te(this.content,e.content),additional_kwargs:ce._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),role:this.role})}}function Ct(n,e="Human",t="AI"){const r=[];for(const i of n){let a;if(i._getType()==="human")a=e;else if(i._getType()==="ai")a=t;else if(i._getType()==="system")a="System";else if(i._getType()==="function")a="Function";else if(i._getType()==="tool")a="Tool";else if(i._getType()==="generic")a=i.role;else throw new Error(`Got unsupported message type: ${i._getType()}`);const s=i.name?`${i.name}, `:"";r.push(`${a}: ${s}${i.content}`)}return r.join(`
`)}async function Br(){return new Nr}let ke;function Mr(){const n="default"in N?N.default:N;return new n({autoStart:!0,concurrency:1})}async function b(n,e){e===!0?await n():(typeof ke>"u"&&(ke=Mr()),ke.add(n))}class Fr{setHandler(e){return this.setHandlers([e])}}class Te{constructor(e,t,r,i,a,s,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}async handleText(e){await Promise.all(this.handlers.map(t=>b(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(i){console.error(`Error in handler ${t.constructor.name}, handleText: ${i}`)}},t.awaitHandlers)))}}class Gr extends Te{getChild(e){const t=new R(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch{console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>b(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(i){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${i}`)}},t.awaitHandlers)))}}class Ze extends Te{async handleLLMNewToken(e,t,r,i,a,s){await Promise.all(this.handlers.map(o=>b(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,e,t!=null?t:{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,s))}catch(l){console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${l}`)}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>b(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(i){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${i}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(i){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${i}`)}},t.awaitHandlers)))}}class Jr extends Te{getChild(e){const t=new R(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,i,a){await Promise.all(this.handlers.map(s=>b(async()=>{var o;if(!s.ignoreChain)try{await((o=s.handleChainError)==null?void 0:o.call(s,e,this.runId,this._parentRunId,this.tags,a))}catch(u){console.error(`Error in handler ${s.constructor.name}, handleChainError: ${u}`)}},s.awaitHandlers)))}async handleChainEnd(e,t,r,i,a){await Promise.all(this.handlers.map(s=>b(async()=>{var o;if(!s.ignoreChain)try{await((o=s.handleChainEnd)==null?void 0:o.call(s,e,this.runId,this._parentRunId,this.tags,a))}catch(u){console.error(`Error in handler ${s.constructor.name}, handleChainEnd: ${u}`)}},s.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>b(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(i){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${i}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(i){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${i}`)}},t.awaitHandlers)))}}class Vr extends Te{getChild(e){const t=new R(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>b(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(i){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${i}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(i){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${i}`)}},t.awaitHandlers)))}}class R extends Fr{constructor(e,t){var r,i,a,s,o,u;super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(r=t==null?void 0:t.handlers)!=null?r:this.handlers,this.inheritableHandlers=(i=t==null?void 0:t.inheritableHandlers)!=null?i:this.inheritableHandlers,this.tags=(a=t==null?void 0:t.tags)!=null?a:this.tags,this.inheritableTags=(s=t==null?void 0:t.inheritableTags)!=null?s:this.inheritableTags,this.metadata=(o=t==null?void 0:t.metadata)!=null?o:this.metadata,this.inheritableMetadata=(u=t==null?void 0:t.inheritableMetadata)!=null?u:this.inheritableMetadata,this._parentRunId=e}async handleLLMStart(e,t,r=void 0,i=void 0,a=void 0,s=void 0,o=void 0,u=void 0){return Promise.all(t.map(async l=>{const c=$();return await Promise.all(this.handlers.map(d=>b(async()=>{var h;if(!d.ignoreLLM)try{await((h=d.handleLLMStart)==null?void 0:h.call(d,e,[l],c,this._parentRunId,a,this.tags,this.metadata,u))}catch(f){console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${f}`)}},d.awaitHandlers))),new Ze(c,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,i=void 0,a=void 0,s=void 0,o=void 0,u=void 0){return Promise.all(t.map(async l=>{const c=$();return await Promise.all(this.handlers.map(d=>b(async()=>{var h,f;if(!d.ignoreLLM)try{if(d.handleChatModelStart)await((h=d.handleChatModelStart)==null?void 0:h.call(d,e,[l],c,this._parentRunId,a,this.tags,this.metadata,u));else if(d.handleLLMStart){const p=Ct(l);await((f=d.handleLLMStart)==null?void 0:f.call(d,e,[p],c,this._parentRunId,a,this.tags,this.metadata,u))}}catch(p){console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${p}`)}},d.awaitHandlers))),new Ze(c,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=$(),i=void 0,a=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>b(async()=>{var l;if(!u.ignoreChain)try{await((l=u.handleChainStart)==null?void 0:l.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,i,o))}catch(c){console.error(`Error in handler ${u.constructor.name}, handleChainStart: ${c}`)}},u.awaitHandlers))),new Jr(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=$(),i=void 0,a=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>b(async()=>{var l;if(!u.ignoreAgent)try{await((l=u.handleToolStart)==null?void 0:l.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(c){console.error(`Error in handler ${u.constructor.name}, handleToolStart: ${c}`)}},u.awaitHandlers))),new Vr(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=$(),i=void 0,a=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>b(async()=>{var l;if(!u.ignoreRetriever)try{await((l=u.handleRetrieverStart)==null?void 0:l.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(c){console.error(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${c}`)}},u.awaitHandlers))),new Gr(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new R(this._parentRunId);for(const i of this.handlers){const a=this.inheritableHandlers.includes(i);r.addHandler(i,a)}for(const i of this.tags){const a=this.inheritableTags.includes(i);r.addTags([i],a)}for(const i of Object.keys(this.metadata)){const a=Object.keys(this.inheritableMetadata).includes(i);r.addMetadata({[i]:this.metadata[i]},a)}for(const i of e)r.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===i.name)||r.addHandler(i,t);return r}static fromHandlers(e){class t extends he{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:$()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static async configure(e,t,r,i,a,s,o){var h,f;let u;(e||t)&&(Array.isArray(e)||!e?(u=new R,u.setHandlers((h=e==null?void 0:e.map(ye))!=null?h:[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(ye):t==null?void 0:t.handlers,!1));const l=ae("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),c=ae("LANGCHAIN_TRACING_V2")==="true",d=c||((f=ae("LANGCHAIN_TRACING"))!=null?f:!1);if(l||d){if(u||(u=new R),l&&!u.handlers.some(p=>p.name===ze.prototype.name)){const p=new ze;u.addHandler(p,!0)}d&&!u.handlers.some(p=>p.name==="langchain_tracer")&&c&&u.addHandler(await Br(),!0)}return(r||i)&&u&&(u.addTags(r!=null?r:[]),u.addTags(i!=null?i:[],!1)),(a||s)&&u&&(u.addMetadata(a!=null?a:{}),u.addMetadata(s!=null?s:{},!1)),u}}function ye(n){return"name"in n?n:he.fromMethods(n)}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const qr=Object.prototype.hasOwnProperty;function zr(n,e){return qr.call(n,e)}function Wr(n){if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)zr(n,t)&&e.push(t);return e}function M(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function Le(n){let e=0;const t=n.length;let r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Kr(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function Tt(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function Ne(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(Ne(n[t]))return!0}else if(typeof n=="object"){const t=Wr(n),r=t.length;for(var e=0;e<r;e++)if(Ne(n[t[e]]))return!0}}return!1}function Xe(n,e){const t=[n];for(const r in e){const i=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof i<"u"&&t.push(`${r}: ${i}`)}return t.join(`
`)}class At extends Error{constructor(e,t,r,i,a){super(Xe(e,{name:t,index:r,operation:i,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=Xe(e,{name:t,index:r,operation:i,tree:a})}}const w=At,Qr=M,Y={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=ge(t,this.path);r&&(r=M(r));const i=V(t,{op:"remove",path:this.from}).removed;return V(t,{op:"add",path:this.path,value:i}),{newDocument:t,removed:r}},copy:function(n,e,t){const r=ge(t,this.from);return V(t,{op:"add",path:this.path,value:M(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:de(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}};var Yr={add:function(n,e,t){return Le(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:Y.move,copy:Y.copy,test:Y.test,_get:Y._get};function ge(n,e){if(e=="")return n;var t={op:"_get",path:e};return V(n,t),t.value}function V(n,e,t=!1,r=!0,i=!0,a=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):_e(e,0)),e.path===""){let s={newDocument:n};if(e.op==="add")return s.newDocument=e.value,s;if(e.op==="replace")return s.newDocument=e.value,s.removed=n,s;if(e.op==="move"||e.op==="copy")return s.newDocument=ge(n,e.from),e.op==="move"&&(s.removed=n),s;if(e.op==="test"){if(s.test=de(n,e.value),s.test===!1)throw new w("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return s.newDocument=n,s}else{if(e.op==="remove")return s.removed=n,s.newDocument=null,s;if(e.op==="_get")return e.value=n,s;if(t)throw new w("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,e,n);return s}}else{r||(n=M(n));const o=(e.path||"").split("/");let u=n,l=1,c=o.length,d,h,f;for(typeof t=="function"?f=t:f=_e;;){if(h=o[l],h&&h.indexOf("~")!=-1&&(h=Tt(h)),i&&(h=="__proto__"||h=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(u[h]===void 0?d=o.slice(0,l).join("/"):l==c-1&&(d=e.path),d!==void 0&&f(e,0,n,d)),l++,Array.isArray(u)){if(h==="-")h=u.length;else{if(t&&!Le(h))throw new w("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,e,n);Le(h)&&(h=~~h)}if(l>=c){if(t&&e.op==="add"&&h>u.length)throw new w("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,e,n);const p=Yr[e.op].call(e,u,h,n);if(p.test===!1)throw new w("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return p}}else if(l>=c){const p=Y[e.op].call(e,u,h,n);if(p.test===!1)throw new w("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return p}if(u=u[h],t&&l<c&&(!u||typeof u!="object"))throw new w("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,e,n)}}}function Ae(n,e,t,r=!0,i=!0){if(t&&!Array.isArray(e))throw new w("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=M(n));const a=new Array(e.length);for(let s=0,o=e.length;s<o;s++)a[s]=V(n,e[s],t,!0,i,s),n=a[s].newDocument;return a.newDocument=n,a}function Zr(n,e,t){const r=V(n,e);if(r.test===!1)throw new w("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function _e(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new w("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(Y[n.op]){if(typeof n.path!="string")throw new w("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new w('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new w("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new w("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&Ne(n.value))throw new w("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var i=n.path.split("/").length,a=r.split("/").length;if(i!==a+1&&i!==a)throw new w("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new w("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var s={op:"_get",path:n.from,value:void 0},o=Ot([s],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new w("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new w("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function Ot(n,e,t){try{if(!Array.isArray(n))throw new w("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Ae(M(e),M(n),t||!0);else{t=t||_e;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(i){if(i instanceof w)return i;throw i}}function de(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),i,a,s;if(t&&r){if(a=n.length,a!=e.length)return!1;for(i=a;i--!==0;)if(!de(n[i],e[i]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(a=o.length,a!==Object.keys(e).length)return!1;for(i=a;i--!==0;)if(!e.hasOwnProperty(o[i]))return!1;for(i=a;i--!==0;)if(s=o[i],!de(n[s],e[s]))return!1;return!0}return n!==n&&e!==e}const Xr=Object.freeze(Object.defineProperty({__proto__:null,JsonPatchError:w,deepClone:Qr,getValueByPointer:ge,applyOperation:V,applyPatch:Ae,applyReducer:Zr,validator:_e,validate:Ot,_areEquals:de},Symbol.toStringTag,{value:"Module"}));({...Xr});class P extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new P({start(r){return i();function i(){return t.read().then(({done:a,value:s})=>{if(a){r.close();return}return r.enqueue(s),i()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new P({async pull(t){const{value:r,done:i}=await e.next();i&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function St(n,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(i){for(;;)if(i.length===0){const a=await n.next();for(const s of t)s.push(a)}else{if(i[0].done)return;yield i.shift().value}})}function X(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){const t={...n};for(const[r,i]of Object.entries(e))r in t?t[r]=X(t[r],i):t[r]=i;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}class ne{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise((r,i)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(r,i):this.firstResult.then(a=>r(void 0),i)})}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}async function en(n,e,t,...r){const i=new ne(e,t),a=await i.setup;return{output:n(i,a,...r),setup:a}}class H{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops}concat(e){const t=this.ops.concat(e.ops),r=Ae({},t);return new He({ops:t,state:r[r.length-1].newDocument})}}class He extends H{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=Ae(this.state,e.ops);return new He({ops:t,state:r[r.length-1].newDocument})}}class It extends ve{constructor(e){var t;super(e),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=(t=e==null?void 0:e.autoClose)!=null?t:!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=P.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){var i;if(e.id===this.rootId)return!1;const t=(i=e.tags)!=null?i:[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>{var s;return(s=this.includeTags)==null?void 0:s.includes(a)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>{var s;return!((s=this.excludeTags)!=null&&s.includes(a))})),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const i=this.keyMapByRunId[e];i&&await this.writer.write(new H({ops:[{op:"add",path:`/logs/${i}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var i,a,s;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new H({ops:[{op:"replace",path:"",value:{id:e.id,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:(i=e.tags)!=null?i:[],metadata:(s=(a=e.extra)==null?void 0:a.metadata)!=null?s:{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};await this.writer.write(new H({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[{op:"add",path:`/logs/${t}/final_output`,value:e.outputs}];e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const i=new H({ops:r});await this.writer.write(i)}finally{if(e.id===this.rootId){const t=new H({ops:[{op:"replace",path:"/final_output",value:e.outputs}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t){const r=this.keyMapByRunId[e.id];if(r===void 0)return;const i=new H({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t}]});await this.writer.write(i)}}const et=25;async function q(n){return R.configure(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function tt(...n){var t,r;const e=B();for(const i of n.filter(a=>!!a))for(const a of Object.keys(i))if(a==="metadata")e[a]={...e[a],...i[a]};else if(a==="tags")e[a]=[...new Set(e[a].concat((t=i[a])!=null?t:[]))];else if(a==="configurable")e[a]={...e[a],...i[a]};else if(a==="callbacks"){const s=e.callbacks,o=i.callbacks;if(Array.isArray(o))if(!s)e.callbacks=o;else if(Array.isArray(s))e.callbacks=s.concat(o);else{const u=s.copy();for(const l of o)u.addHandler(ye(l),!0);e.callbacks=u}else if(o)if(!s)e.callbacks=o;else if(Array.isArray(s)){const u=o.copy();for(const l of s)u.addHandler(ye(l),!0);e.callbacks=u}else e.callbacks=new R(o._parentRunId,{handlers:s.handlers.concat(o.handlers),inheritableHandlers:s.inheritableHandlers.concat(o.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(o.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(o.inheritableTags))),metadata:{...s.metadata,...o.metadata}})}else{const s=a;e[s]=(r=i[s])!=null?r:e[s]}return e}const tn=new Set(["string","number","boolean"]);function B(n){var t;let e={tags:[],metadata:{},callbacks:void 0,recursionLimit:25};if(n&&(e={...e,...n}),n!=null&&n.configurable)for(const r of Object.keys(n.configurable))tn.has(typeof n.configurable[r])&&!((t=e.metadata)!=null&&t[r])&&(e.metadata||(e.metadata={}),e.metadata[r]=n.configurable[r]);return e}function A(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:i,configurable:a}={}){const s=B(n);return e!==void 0&&(delete s.runName,s.callbacks=e),r!==void 0&&(s.recursionLimit=r),t!==void 0&&(s.maxConcurrency=t),i!==void 0&&(s.runName=i),a!==void 0&&(s.configurable={...s.configurable,...a}),s}const rn=[400,401,402,403,404,405,406,407,408,409],nn=n=>{var t,r,i;if(n.message.startsWith("Cancel")||n.message.startsWith("TimeoutError")||n.name==="TimeoutError"||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;const e=(r=(t=n==null?void 0:n.response)==null?void 0:t.status)!=null?r:n==null?void 0:n.status;if(e&&rn.includes(+e))throw n;if(((i=n==null?void 0:n.error)==null?void 0:i.code)==="insufficient_quota"){const a=new Error(n==null?void 0:n.message);throw a.name="InsufficientQuotaError",a}};class an{constructor(e){var r,i,a;Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=(r=e.maxConcurrency)!=null?r:1/0,this.maxRetries=(i=e.maxRetries)!=null?i:6,this.onFailedAttempt=(a=e.onFailedAttempt)!=null?a:nn;const t="default"in N?N.default:N;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>z.exports(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((i,a)=>{var s;(s=e.signal)==null||s.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}class Rt extends ve{constructor({config:e,onStart:t,onEnd:r,onError:i}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=i}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}}function E(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}class O extends W{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){var r,i;const t=(i=(r=this.name)!=null?r:this.constructor.lc_name())!=null?i:this.constructor.name;return e?`${t}${e}`:t}bind(e){return new ee({bound:this,kwargs:e,config:{}})}map(){return new be({bound:this})}withRetry(e){return new sn({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new ee({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new on({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)){if(e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);return e.map(B)}return Array.from({length:t},()=>B(e))}async batch(e,t,r){var u,l;const i=this._getOptionsList(t!=null?t:{},e.length),a=(l=(u=i[0])==null?void 0:u.maxConcurrency)!=null?l:r==null?void 0:r.maxConcurrency,s=new an({maxConcurrency:a,onFailedAttempt:c=>{throw c}}),o=e.map((c,d)=>s.call(async()=>{try{return await this.invoke(c,i[d])}catch(h){if(r!=null&&r.returnExceptions)return h;throw h}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=new ne(this._streamIterator(e,t));return await r.setup,P.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e={}){const t=B({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency}),r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,[t,r]}async _callWithConfig(e,t,r){var u;const i=B(r),a=await q(i),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),E(t,"input"),void 0,i==null?void 0:i.runType,void 0,void 0,(u=i==null?void 0:i.runName)!=null?u:this.getName()));let o;try{o=await e.call(this,t,i,s)}catch(l){throw await(s==null?void 0:s.handleChainError(l)),l}return await(s==null?void 0:s.handleChainEnd(E(o,"output"))),o}async _batchWithConfig(e,t,r,i){const a=this._getOptionsList(r!=null?r:{},t.length),s=await Promise.all(a.map(q)),o=await Promise.all(s.map((l,c)=>{var d;return l==null?void 0:l.handleChainStart(this.toJSON(),E(t[c],"input"),void 0,a[c].runType,void 0,void 0,(d=a[c].runName)!=null?d:this.getName())}));let u;try{u=await e.call(this,t,a,o,i)}catch(l){throw await Promise.all(o.map(c=>c==null?void 0:c.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(E(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let i,a=!0,s,o=!0;const u=B(r),l=await q(u);async function*c(){for await(const h of e){if(a)if(i===void 0)i=h;else try{i=X(i,h)}catch{i=void 0,a=!1}yield h}}let d;try{const h=await en(t.bind(this),c(),async()=>{var m;return l==null?void 0:l.handleChainStart(this.toJSON(),{input:""},void 0,u==null?void 0:u.runType,void 0,void 0,(m=u==null?void 0:u.runName)!=null?m:this.getName())},u);d=h.setup;const f=m=>m.name==="log_stream_tracer",p=d==null?void 0:d.handlers.find(f);let v=h.output;p!==void 0&&d!==void 0&&(v=await p.tapOutputIterable(d.runId,h.output));for await(const m of v)if(yield m,o)if(s===void 0)s=m;else try{s=X(s,m)}catch{s=void 0,o=!1}}catch(h){throw await(d==null?void 0:d.handleChainError(h,void 0,void 0,void 0,{inputs:E(i,"input")})),h}await(d==null?void 0:d.handleChainEnd(s!=null?s:{},void 0,void 0,void 0,{inputs:E(i,"input")}))}pipe(e){return new Z({first:this,last:J(e)})}pick(e){return this.pipe(new ln(e))}assign(e){return this.pipe(new un(new fe({steps:e})))}async*transform(e,t){let r;for await(const i of e)r===void 0?r=i:r=X(r,i);yield*this._streamIterator(r,t)}async*streamLog(e,t,r){const i=new It({...r,autoClose:!1}),a=B(t),{callbacks:s}=a;if(s===void 0)a.callbacks=[i];else if(Array.isArray(s))a.callbacks=s.concat([i]);else{const c=s.copy();c.inheritableHandlers.push(i),a.callbacks=c}const o=this.stream(e,a);async function u(){try{const c=await o;for await(const d of c){const h=new H({ops:[{op:"add",path:"/streamed_output/-",value:d}]});await i.writer.write(h)}}finally{await i.writer.close()}}const l=u();try{for await(const c of i)yield c}finally{await l}}static isRunnable(e){return e?e.lc_runnable:!1}withListeners({onStart:e,onEnd:t,onError:r}){return new ee({bound:this,config:{},configFactories:[i=>({callbacks:[new Rt({config:i,onStart:e,onEnd:t,onError:r})]})]})}}class ee extends O{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=tt(this.config,...e);return tt(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(t,this.kwargs))}async batch(e,t,r){const i=Array.isArray(t)?await Promise.all(t.map(async a=>this._mergeConfig(a,this.kwargs))):await this._mergeConfig(t,this.kwargs);return this.bound.batch(e,i,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(t,this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(t,this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(t,this.kwargs))}static isRunnableBinding(e){return e.bound&&O.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new ee({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[i=>({callbacks:[new Rt({config:i,onStart:e,onEnd:t,onError:r})]})]})}}class be extends O{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new be({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,A(t,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new be({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class sn extends ee{static lc_name(){return"RunnableRetry"}constructor(e){var t,r;super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=(t=e.maxAttemptNumber)!=null?t:this.maxAttemptNumber,this.onFailedAttempt=(r=e.onFailedAttempt)!=null?r:this.onFailedAttempt}_patchConfigForRetry(e,t,r){const i=e>1?`retry:attempt:${e}`:void 0;return A(t,{callbacks:r==null?void 0:r.getChild(i)})}async _invoke(e,t,r){return z.exports(i=>super.invoke(e,this._patchConfigForRetry(i,t,r)),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,i){const a={};try{await z.exports(async s=>{const o=e.map((h,f)=>f).filter(h=>a[h.toString()]===void 0||a[h.toString()]instanceof Error),u=o.map(h=>e[h]),l=o.map(h=>this._patchConfigForRetry(s,t==null?void 0:t[h],r==null?void 0:r[h])),c=await super.batch(u,l,{...i,returnExceptions:!0});let d;for(let h=0;h<c.length;h+=1){const f=c[h],p=o[h];f instanceof Error&&d===void 0&&(d=f),a[p.toString()]=f}if(d)throw d;return c},{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(s){if((i==null?void 0:i.returnExceptions)!==!0)throw s}return Object.keys(a).sort((s,o)=>parseInt(s,10)-parseInt(o,10)).map(s=>a[parseInt(s,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class Z extends O{static lc_name(){return"RunnableSequence"}constructor(e){var t;super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=(t=e.middle)!=null?t:this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=await q(t),i=await(r==null?void 0:r.handleChainStart(this.toJSON(),E(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName));let a=e,s;try{const o=[this.first,...this.middle];for(let u=0;u<o.length;u+=1)a=await o[u].invoke(a,A(t,{callbacks:i==null?void 0:i.getChild(`seq:step:${u+1}`)}));s=await this.last.invoke(a,A(t,{callbacks:i==null?void 0:i.getChild(`seq:step:${this.steps.length}`)}))}catch(o){throw await(i==null?void 0:i.handleChainError(o)),o}return await(i==null?void 0:i.handleChainEnd(E(s,"output"))),s}async batch(e,t,r){const i=this._getOptionsList(t!=null?t:{},e.length),a=await Promise.all(i.map(q)),s=await Promise.all(a.map((u,l)=>u==null?void 0:u.handleChainStart(this.toJSON(),E(e[l],"input"),void 0,void 0,void 0,void 0,i[l].runName)));let o=e;try{for(let u=0;u<this.steps.length;u+=1)o=await this.steps[u].batch(o,s.map((c,d)=>{const h=c==null?void 0:c.getChild(`seq:step:${u+1}`);return A(i[d],{callbacks:h})}),r)}catch(u){throw await Promise.all(s.map(l=>l==null?void 0:l.handleChainError(u))),u}return await Promise.all(s.map(u=>u==null?void 0:u.handleChainEnd(E(o,"output")))),o}async*_streamIterator(e,t){const r=await q(t),i=await(r==null?void 0:r.handleChainStart(this.toJSON(),E(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),a=[this.first,...this.middle,this.last];let s=!0,o;async function*u(){yield e}try{let l=a[0].transform(u(),A(t,{callbacks:i==null?void 0:i.getChild("seq:step:1")}));for(let c=1;c<a.length;c+=1)l=await a[c].transform(l,A(t,{callbacks:i==null?void 0:i.getChild(`seq:step:${c+1}`)}));for await(const c of l)if(yield c,s)if(o===void 0)o=c;else try{o=X(o,c)}catch{o=void 0,s=!1}}catch(l){throw await(i==null?void 0:i.handleChainError(l)),l}await(i==null?void 0:i.handleChainEnd(E(o,"output")))}pipe(e){var t;return Z.isRunnableSequence(e)?new Z({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:(t=this.name)!=null?t:e.name}):new Z({first:this.first,middle:[...this.middle,this.last],last:J(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&O.isRunnable(e)}static from([e,...t],r){return new Z({first:J(e),middle:t.slice(0,-1).map(J),last:J(t[t.length-1]),name:r})}}class fe extends O{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=J(r)}static from(e){return new fe({steps:e})}async invoke(e,t){const r=await q(t),i=await(r==null?void 0:r.handleChainStart(this.toJSON(),{input:e},void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),a={};try{await Promise.all(Object.entries(this.steps).map(async([s,o])=>{a[s]=await o.invoke(e,A(t,{callbacks:i==null?void 0:i.getChild(`map:key:${s}`)}))}))}catch(s){throw await(i==null?void 0:i.handleChainError(s)),s}return await(i==null?void 0:i.handleChainEnd(a)),a}async*_transform(e,t,r){const i={...this.steps},a=St(e,Object.keys(i).length),s=new Map(Object.entries(i).map(([o,u],l)=>{const c=u.transform(a[l],A(r,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,c.next().then(d=>({key:o,gen:c,result:d}))]}));for(;s.size;){const{key:o,result:u,gen:l}=await Promise.race(s.values());s.delete(o),u.done||(yield{[o]:u.value},s.set(o,l.next().then(c=>({key:o,gen:l,result:c}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const i=new ne(this.transform(r(),t));return await i.setup,P.fromAsyncGenerator(i)}}class Be extends O{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new Be({func:e})}async _invoke(e,t,r){var a;let i=await this.func(e,{...t,config:t});if(i&&O.isRunnable(i)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");i=await i.invoke(e,A(t,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((a=t==null?void 0:t.recursionLimit)!=null?a:et)-1}))}return i}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){var s;let i;for await(const o of e)if(i===void 0)i=o;else try{i=X(i,o)}catch{i=o}const a=await this.func(i,{...r,config:r});if(a&&O.isRunnable(a)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");const o=await a.stream(i,A(r,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((s=r==null?void 0:r.recursionLimit)!=null?s:et)-1}));for await(const u of o)yield u}else yield a}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const i=new ne(this.transform(r(),t));return await i.setup,P.fromAsyncGenerator(i)}}class on extends O{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=await R.configure(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),i=await(r==null?void 0:r.handleChainStart(this.toJSON(),E(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName));let a;for(const s of this.runnables())try{const o=await s.invoke(e,A(t,{callbacks:i==null?void 0:i.getChild()}));return await(i==null?void 0:i.handleChainEnd(E(o,"output"))),o}catch(o){a===void 0&&(a=o)}throw a===void 0?new Error("No error stored at end of fallback."):(await(i==null?void 0:i.handleChainError(a)),a)}async batch(e,t,r){if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const i=this._getOptionsList(t!=null?t:{},e.length),a=await Promise.all(i.map(u=>R.configure(u==null?void 0:u.callbacks,void 0,u==null?void 0:u.tags,void 0,u==null?void 0:u.metadata))),s=await Promise.all(a.map((u,l)=>u==null?void 0:u.handleChainStart(this.toJSON(),E(e[l],"input"),void 0,void 0,void 0,void 0,i[l].runName)));let o;for(const u of this.runnables())try{const l=await u.batch(e,s.map((c,d)=>A(i[d],{callbacks:c==null?void 0:c.getChild()})),r);return await Promise.all(s.map((c,d)=>c==null?void 0:c.handleChainEnd(E(l[d],"output")))),l}catch(l){o===void 0&&(o=l)}throw o?(await Promise.all(s.map(u=>u==null?void 0:u.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function J(n){if(typeof n=="function")return new Be({func:n});if(O.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){const e={};for(const[t,r]of Object.entries(n))e[t]=J(r);return new fe({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class un extends O{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof fe&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const i=this.mapper.getStepsKeys(),[a,s]=St(e),o=this.mapper.transform(s,A(r,{callbacks:t==null?void 0:t.getChild()})),u=o.next();for await(const l of a){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);const c=Object.fromEntries(Object.entries(l).filter(([d])=>!i.includes(d)));Object.keys(c).length>0&&(yield c)}yield(await u).value;for await(const l of o)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const i=new ne(this.transform(r(),t));return await i.setup,P.fromAsyncGenerator(i)}}class ln extends O{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const i=new ne(this.transform(r(),t));return await i.setup,P.fromAsyncGenerator(i)}}class cn{constructor(e){var t;Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=e.pageContent?e.pageContent.toString():this.pageContent,this.metadata=(t=e.metadata)!=null?t:{}}}class Pt extends W{}class dn extends Pt{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Et(this.value)]}}class hn extends Pt{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Ct(this.messages)}toChatMessages(){return this.messages}}const fn="__run";class Oe{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new Oe({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class Me extends Oe{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new Me({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}function pn(n){return n!=null&&typeof n=="object"&&"on"in n}async function xt(n,e){if(pn(n))return new Promise(r=>{n.on("readable",()=>{let i;for(;;){if(i=n.read(),i==null){e(new Uint8Array,!0);break}e(i)}r()})});const t=n.getReader();for(;;){const r=await t.read();if(r.done){e(new Uint8Array,!0);break}e(r.value)}}function kt(n){let e,t,r,i=!1;return function(s,o){if(o){n(s,0,!0);return}e===void 0?(e=s,t=0,r=-1):e=mn(e,s);const u=e.length;let l=0;for(;t<u;){i&&(e[t]===10&&(l=++t),i=!1);let c=-1;for(;t<u&&c===-1;++t)switch(e[t]){case 58:r===-1&&(r=t-l);break;case 13:i=!0;case 10:c=t;break}if(c===-1)break;n(e.subarray(l,c),r),l=t,r=-1}l===u?e=void 0:l!==0&&(e=e.subarray(l),t-=l)}}function $t(n,e,t){let r=$e();const i=new TextDecoder;return function(s,o,u){if(u){yn(r)||(n==null||n(r),r=$e());return}if(s.length===0)n==null||n(r),r=$e();else if(o>0){const l=i.decode(s.subarray(0,o)),c=o+(s[o+1]===32?2:1),d=i.decode(s.subarray(c));switch(l){case"data":r.data=r.data?r.data+`
`+d:d;break;case"event":r.event=d;break;case"id":e==null||e(r.id=d);break;case"retry":{const h=parseInt(d,10);Number.isNaN(h)||t==null||t(r.retry=h);break}}}}}function mn(n,e){const t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function $e(){return{data:"",event:"",id:"",retry:void 0}}function wn(n){const e=new ReadableStream({async start(t){const r=$t(a=>{a.data&&t.enqueue(a.data)});await xt(n,kt((a,s,o)=>{r(a,s,o),o&&t.close()}))}});return P.fromReadableStream(e)}function yn(n){return n.data===""&&n.event===""&&n.id===""&&n.retry===void 0}function U(n,e){for(const t of e)if(!n.has(t))return!1;return!0}function x(n){if(Array.isArray(n))return n.map(x);if(typeof n=="object"){if(!n||n instanceof Date)return n;const e=Object.keys(n),t=new Set(e);if(U(t,new Set(["page_content","metadata"])))return new cn({pageContent:n.page_content,metadata:n.metadata});if(U(t,new Set(["content","type","additional_kwargs"]))){if(n.type==="HumanMessage"||n.type==="human")return new Et({content:n.content});if(n.type==="SystemMessage"||n.type==="system")return new Dr({content:n.content});if(n.type==="ChatMessage"||n.type==="chat")return new Ce({content:n.content,role:n.role});if(n.type==="FunctionMessage"||n.type==="function")return new Ur({content:n.content,name:n.name});if(n.type==="ToolMessage"||n.type==="tool")return new Hr({content:n.content,tool_call_id:n.tool_call_id});if(n.type==="AIMessage"||n.type==="ai")return new jr({content:n.content});if(n.type==="HumanMessageChunk")return new se({content:n.content});if(n.type==="SystemMessageChunk")return new ue({content:n.content});if(n.type==="ChatMessageChunk")return new ce({content:n.content,role:n.role});if(n.type==="FunctionMessageChunk")return new le({content:n.content,name:n.name});if(n.type==="ToolMessageChunk")return new we({content:n.content,tool_call_id:n.tool_call_id});if(n.type==="AIMessageChunk")return new oe({content:n.content})}if(U(t,new Set(["text","generation_info","type"]))){if(n.type==="ChatGenerationChunk")return new Me({message:x(n.message),text:n.text,generationInfo:n.generation_info});if(n.type==="ChatGeneration")return{message:x(n.message),text:n.text,generationInfo:n.generation_info};if(n.type==="GenerationChunk")return new Oe({text:n.text,generationInfo:n.generation_info});if(n.type==="Generation")return{text:n.text,generationInfo:n.generation_info}}if(U(t,new Set(["tool","tool_input","log","type"]))&&n.type==="AgentAction")return{tool:n.tool,toolInput:n.tool_input,log:n.log};if(U(t,new Set(["return_values","log","type"]))&&n.type==="AgentFinish")return{returnValues:n.return_values,log:n.log};if(U(t,new Set(["generations","run","type"]))&&n.type==="LLMResult")return{generations:x(n.generations),llmOutput:n.llm_output,[fn]:n.run};if(U(t,new Set(["messages"])))return new hn({messages:n.messages.map(a=>x(a))});if(U(t,new Set(["text"])))return new dn(n.text);const r=a=>[a,x(n[a])];return Object.fromEntries(e.map(r))}return n}function gn(n){const e=JSON.parse(n);return x(e)}function rt(n){const e={...n};return delete e.callbacks,e}class _n extends O{constructor(e){super(e),Object.defineProperty(this,"url",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","schema","runnable","remote"]});const{url:t,options:r}=e;this.url=t.replace(/\/$/,""),this.options=r}async post(e,t){var r,i,a;return await fetch(`${this.url}${e}`,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json",...(r=this.options)==null?void 0:r.headers},signal:AbortSignal.timeout((a=(i=this.options)==null?void 0:i.timeout)!=null?a:6e4)})}async invoke(e,t){const[r,i]=this._separateRunnableConfigFromCallOptions(t),a=await this.post("/invoke",{input:e,config:rt(r),kwargs:i!=null?i:{}});return x((await a.json()).output)}async _batch(e,t,r,i){var c;if(i!=null&&i.returnExceptions)throw new Error("returnExceptions is not supported for remote clients");const a=t==null?void 0:t.map(d=>this._separateRunnableConfigFromCallOptions(d)),[s,o]=(c=a==null?void 0:a.reduce(([d,h],[f,p])=>[[...d,f],[...h,p]],[[],[]]))!=null?c:[void 0,void 0],l=await(await this.post("/batch",{inputs:e,config:(s!=null?s:[]).map(rt).map(d=>({...d,...i})),kwargs:o})).json();if(!l.output)throw new Error("Invalid response from remote runnable");return x(l.output)}async batch(e,t,r){if(r!=null&&r.returnExceptions)throw Error("returnExceptions is not supported for remote clients");return this._batchWithConfig(this._batch.bind(this),e,t,r)}async stream(e,t){const[r,i]=this._separateRunnableConfigFromCallOptions(t),a=await this.post("/stream",{input:e,config:r,kwargs:i});if(!a.ok){const u=await a.json(),l=new Error(`RemoteRunnable call failed with status code ${a.status}: ${u.message}`);throw l.response=a,l}const{body:s}=a;if(!s)throw new Error("Could not begin remote stream. Please check the given URL and try again.");const o=new ReadableStream({async start(u){const l=$t(d=>{d.data&&u.enqueue(gn(d.data))});await xt(s,kt((d,h,f)=>{l(d,h,f),f&&u.close()}))}});return P.fromReadableStream(o)}async*streamLog(e,t,r){const[i,a]=this._separateRunnableConfigFromCallOptions(t),s=new It({...r,autoClose:!1}),{callbacks:o}=i;if(o===void 0)i.callbacks=[s];else if(Array.isArray(o))i.callbacks=o.concat([s]);else{const h=o.copy();h.inheritableHandlers.push(s),i.callbacks=h}const u={include_names:r==null?void 0:r.includeNames,include_types:r==null?void 0:r.includeTypes,include_tags:r==null?void 0:r.includeTags,exclude_names:r==null?void 0:r.excludeNames,exclude_types:r==null?void 0:r.excludeTypes,exclude_tags:r==null?void 0:r.excludeTags},l=await this.post("/stream_log",{input:e,config:i,kwargs:a,...u,diff:!1}),{body:c}=l;if(!c)throw new Error("Could not begin remote stream log. Please check the given URL and try again.");const d=wn(c);for await(const h of d)yield x(JSON.parse(h))}}var L=[];function bn(n){n.preventDefault();let t=new FormData(n.target).get("message");L.push({user:t}),Cn(),Lt(L[L.length-1]),vn()}async function vn(){let n=L[L.length-1].user;const t=await new _n({url:"https://gullgpt.study/chat/su"}).stream(n.toLowerCase());L.push({ai:""});let r=Lt(L[L.length-1]);for await(const i of t)(typeof i=="string"||i instanceof String)&&(r.innerHTML+=i,Nt());Tn()}function Lt(n){let e=document.getElementById("chatHolder"),t=document.createElement("div"),r=document.createElement("span");return n.hasOwnProperty("user")?(r.textContent=n.user,r.classList.add("bg-gray-300","px-2","py-2","mt-2","mb-2","w-1/3","rounded-b-xl","rounded-tr-xl","shadow-yellow-400","shadow-md","loading:animate-pulse"),t.classList.add("flex","flex-col","items-end")):(r.textContent=n.ai,r.classList.add("px-2","py-2","mt-2","mb-2","rounded-b-xl","rounded-tr-xl","w-1/2","loading:animate-pulse"),t.classList.add("bg-red-800","px-2","py-2","rounded-b-xl","rounded-tl-xl","mb-2","mt-2","w-1/2","text-white","shadow-yellow-400","shadow-md","loading:animate-bounce")),e.appendChild(t),t.appendChild(r),r}function En(){L=[];let n=document.getElementById("chatHolder");n.innerHTML=""}function Cn(){let n=document.getElementById("message");n.value="",document.getElementById("inputBar").classList.add("animate-bounce"),n.disabled=!0,n.placeholder="Loading response...";let t=document.getElementById("clear");t.disabled=!0}function Tn(){let n=document.getElementById("message");document.getElementById("inputBar").classList.remove("animate-bounce"),n.disabled=!1,n.placeholder="Ask me something...";let t=document.getElementById("clear");t.disabled=!1,Nt()}function Nt(){document.getElementById("inputBar").scrollIntoView({behavior:"smooth"})}document.getElementById("clear").onclick=En;document.getElementById("newChat").onsubmit=bn;
